# MarlApps

A personal productivity suite that runs entirely in your browser. No server, no accounts, no tracking — just offline-first PWA apps with localStorage persistence.

## Project Structure

```
marlapps/
  index.html              Main launcher page
  manifest.json           PWA manifest (auto-patched by build)
  service-worker.js       Offline cache (auto-patched by build)
  build.js                Build script — run after adding/removing apps
  favicon.ico

  icons/                  PWA icons (various sizes)

  themes/
    tokens.css            Design tokens (spacing, typography, radii)
    dark.css              Dark theme (launcher)
    light.css             Light theme (launcher)
    futuristic.css        Futuristic theme (launcher)
    amalfi.css            Amalfi theme (launcher)
    app-common.css        Shared theme + base styles for all apps

  launcher/
    launcher.js           Main launcher controller
    launcher.css          Launcher styles
    app-loader.js         App discovery, search, recents
    theme-manager.js      Theme persistence + switching
    search.js             Search bar controller
    settings.js           Settings drawer, export/import/reset
    pwa-install.js        PWA install prompt + service worker registration

  registry/
    apps.json             App registry (auto-generated by build)

  apps/
    {app-id}/             One folder per app
      manifest.json       App metadata (single source of truth)
      index.html          App entry point
      styles.css          App styles (imports app-common.css)
      app.js              App logic
      icon.svg            App icon
```

## How the Launcher Works

1. On page load, `AppLoader` fetches `registry/apps.json` to discover available apps
2. For each registered app, it fetches `apps/{folder}/manifest.json` to get metadata (name, description, categories, icon, etc.)
3. Apps are rendered as cards in the launcher grid, sorted by `order`
4. When a user opens an app, it loads inside a sandboxed `<iframe>` pointing to the app's `index.html`
5. The launcher supports `?app={id}` URL parameters for direct deep-linking (used by PWA shortcuts)
6. Theme changes are broadcast to the iframe via `postMessage`

## Adding a New App

### 1. Create the app folder

Create `apps/{your-app-id}/` with these 5 files:

```
apps/my-app/
  manifest.json
  index.html
  styles.css
  app.js
  icon.svg
```

### 2. Write `manifest.json`

```json
{
  "id": "my-app",
  "name": "My App",
  "shortName": "MyApp",
  "description": "A short description of what it does",
  "icon": "icon.svg",
  "entry": "index.html",
  "categories": ["Tools"],
  "order": 7,
  "storageKeys": ["marlapps-my-app"],
  "version": "1.0.0",
  "author": "MarlApps"
}
```

| Field | Description |
|-------|-------------|
| `id` | Unique identifier, must match the folder name |
| `name` | Display name shown in the launcher |
| `shortName` | Short name for PWA shortcuts (keep under 12 chars) |
| `description` | One-line description for the launcher card |
| `icon` | Filename of the SVG icon (always `icon.svg`) |
| `entry` | Entry HTML file (always `index.html`) |
| `categories` | Array of categories for filtering (e.g. `["Tools", "Planning"]`) |
| `order` | Sort position in the launcher (lower = first) |
| `storageKeys` | Array of localStorage keys your app uses |
| `version` | Semver version string |
| `author` | Author name |

### 3. Write `index.html`

Minimal template:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My App - MarlApps</title>
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Your app HTML here -->
  </div>

  <script src="app.js"></script>
</body>
</html>
```

Key points:
- No `<link>` to theme CSS in HTML — `styles.css` imports it via `@import`
- The favicon path is `../../favicon.ico` (two levels up from `apps/{id}/`)
- Keep the structure simple: one CSS file, one JS file

### 4. Write `styles.css`

```css
/* Import the shared theme (provides colors, spacing, buttons, inputs, modals, etc.) */
@import url('../../themes/app-common.css');

/* Optional: Override accent color for your app */
:root {
  --app-accent: #6366f1;
  --app-accent-hover: #4f46e5;
  --app-accent-light: rgba(99, 102, 241, 0.15);
}

/* Your app styles here — use the theme variables */
.app-container {
  padding: var(--space-4);
}

.my-element {
  background: var(--app-bg-secondary);
  color: var(--app-text-primary);
  border: 1px solid var(--app-border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--app-shadow-sm);
}
```

### 5. Write `app.js`

```js
class MyApp {
  constructor() {
    this.data = this.loadData();
    this.syncThemeWithParent();
    // ... init your app
  }

  // Required: Theme sync so your app follows the launcher's theme
  syncThemeWithParent() {
    try {
      const savedTheme = localStorage.getItem('marlapps-theme');
      if (savedTheme) {
        this.applyTheme(savedTheme);
      }
    } catch (e) {
      // Fail silently
    }

    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'theme-change') {
        this.applyTheme(event.data.theme);
      }
    });
  }

  applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
  }

  // localStorage: always use marlapps-{app-id} as the key
  loadData() {
    const saved = localStorage.getItem('marlapps-my-app');
    return saved ? JSON.parse(saved) : {};
  }

  saveData() {
    localStorage.setItem('marlapps-my-app', JSON.stringify(this.data));
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new MyApp();
});
```

### 6. Create `icon.svg`

Provide an SVG icon for your app. It should look good at small sizes (24x24) and be a single color that works on dark backgrounds.

### 7. Run the build

```bash
node build.js
```

This auto-updates:
- `registry/apps.json` — app registry used by the launcher
- `manifest.json` — PWA shortcuts for all apps
- `service-worker.js` — offline cache entries for all app files

That's it. Your app will appear in the launcher.

## Theme System

### How it works

Apps run inside iframes and don't have access to the launcher's CSS. Instead, each app imports `themes/app-common.css` which provides:

1. **CSS custom properties** that change per theme (colors, shadows, scrollbars)
2. **Base styles** for `body`, buttons (`.btn`, `.btn-primary`, `.btn-danger`), inputs, modals, empty states, and scrollbars
3. **Spacing tokens** (`--space-1` through `--space-8`)
4. **Border radii** (`--radius-sm`, `--radius-md`, `--radius-lg`, `--radius-full`)
5. **Transitions** (`--transition-fast`, `--transition-normal`)

When the user changes themes in the launcher, it sends a `postMessage` to the iframe. The app's `syncThemeWithParent()` listener catches this and sets `data-theme` on `<html>`, which activates the matching CSS variable overrides.

### Available CSS variables

| Variable | Description |
|----------|-------------|
| `--app-bg-primary` | Main background |
| `--app-bg-secondary` | Card/panel background |
| `--app-bg-tertiary` | Subtle alternate background |
| `--app-text-primary` | Primary text |
| `--app-text-secondary` | Secondary/muted text |
| `--app-text-tertiary` | Placeholder/disabled text |
| `--app-border-color` | Standard borders |
| `--app-border-light` | Subtle borders |
| `--app-bg-hover` | Hover state background |
| `--app-shadow-sm/md/lg` | Box shadows |
| `--app-accent` | Primary action color (override per app) |
| `--app-accent-hover` | Primary action hover color |
| `--app-success` | Success/positive color |
| `--app-warning` | Warning color |
| `--app-danger` | Danger/destructive color |
| `--app-info` | Informational color |

### Available themes

| Theme | Key | Description |
|-------|-----|-------------|
| Dark | `dark` | Deep blue-purple dark theme (default) |
| Light | `light` | Clean light grey theme |
| Futuristic | `futuristic` | Cyan-on-black sci-fi theme |
| Amalfi | `amalfi` | Warm terracotta/parchment theme |

## localStorage Convention

All storage keys follow the pattern `marlapps-{app-id}`:

| App | Key |
|-----|-----|
| Pomodoro Timer | `marlapps-pomodoro-timer` |
| Kanban Board | `marlapps-kanban-board` |
| Todo List | `marlapps-todo-list` |
| Notes | `marlapps-notes` |
| Habit Tracker | `marlapps-habits` |
| Mirror | `marlapps-mirror` |

Global keys:
- `marlapps-theme` — current theme name
- `marlapps-recents` — recently opened apps

The `storageKeys` field in your app's `manifest.json` tells the settings manager which keys to include in export/import and which to delete when the user clears your app's data.

## Build Script

`node build.js` scans `apps/*/manifest.json` and patches three files in-place:

1. **`registry/apps.json`** — the app registry that `AppLoader` fetches at runtime
2. **`manifest.json`** — the `shortcuts` array (PWA app shortcuts)
3. **`service-worker.js`** — the file cache list between `// AUTO:APP-CACHE-START` and `// AUTO:APP-CACHE-END` markers

It also bumps the service worker cache version so returning users get the update.

Run it whenever you add, remove, or rename an app.
